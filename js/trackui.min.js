/*! evtrack -- UI module */
(function(g){var h="mousedown mouseup mousemove mouseover mouseout mousewheel ";h+="touchstart touchend touchmove keydown keyup keypress ";h+="click dblclick scroll change select submit reset contextmenu cut copy paste";var d="load unload beforeunload blur focus resize error online offline";h=h.split(" ");d=d.split(" ");var b=h.concat(d);var c=0,f=0,e=[];var a={settings:{postServer:"http://my.server.org/save.script",postInterval:30,regularEvents:"*",pollingEvents:"",pollingMs:150,taskName:"evtrack",layoutType:"liquid",debug:false},record:function(j){f=new Date().getTime();for(var k in a.settings){if(j.hasOwnProperty(k)&&j[k]!==null){a.settings[k]=j[k]}}a.log("Recording starts...",f,a.settings);a.addEventListeners();setTimeout(function(){a.initNewData(true)},a.settings.postInterval*1000)},addEventListeners:function(){if(a.settings.regularEvents=="*"){a.addCustomEventListeners(b)}else{a.log("Settings regular events...");a.settings.regularEvents=a.settings.regularEvents.split(" ");a.addCustomEventListeners(a.settings.regularEvents)}if(a.settings.pollingEvents=="*"){a.addCustomEventListeners(b)}else{a.log("Settings polling events...");a.settings.pollingEvents=a.settings.pollingEvents.split(" ");a.addCustomEventListeners(a.settings.pollingEvents)}var j=(typeof g.onbeforeunload==="function")?"beforeunload":"unload";TrackLib.Events.add(g,j,a.flush)},addCustomEventListeners:function(l){a.log("Adding event listeners:",l);for(var j=0;j<l.length;++j){var k=l[j];if(!k){continue}if(h.indexOf(k)>-1){TrackLib.Events.add(document,k,a.docHandler);a.log("Adding document event:",k);if(document.attachEvent){if(k=="focus"){TrackLib.Events.add(document.body,"focusin",a.winHandler)}if(k=="blur"){TrackLib.Events.add(document.body,"focusout",a.winHandler)}}}else{if(d.indexOf(k)>-1){TrackLib.Events.add(g,k,a.winHandler);a.log("Adding window event:",k)}}}},initNewData:function(j){var m=TrackLib.Dimension.getWindowSize(),l=TrackLib.Dimension.getDocumentSize(),k="url="+escape(g.location.href);k+="&screenw="+screen.width;k+="&screenh="+screen.height;k+="&winw="+m.width;k+="&winh="+m.height;k+="&docw="+l.width;k+="&doch="+l.height;k+="&info="+e;k+="&task="+a.settings.taskName;k+="&layout="+a.settings.layoutType;k+="&cookies="+document.cookie;k+="&action=init";a.send({async:j,postdata:k,callback:a.setUserId});e=[]},setUserId:function(j){c=parseInt(j);a.log("setUserId:",c);if(c){setInterval(function(){a.appendData(true)},a.settings.postInterval*1000)}},appendData:function(j){var k="uid="+c;k+="&info="+e;k+="&action=append";a.send({async:j,postdata:k});e=[]},send:function(j){j.url=a.settings.postServer;TrackLib.XHR.sendAjaxRequest(j)},docHandler:function(j){if(j.type.indexOf("touch")>-1){a.touchHandler(j)}else{a.eventHandler(j)}},winHandler:function(j){a.eventHandler(j)},eventHandler:function(n){n=TrackLib.Events.fix(n);var l=new Date().getTime(),k=n.type,m=true;if(a.settings.pollingMs>0&&a.settings.pollingEvents.indexOf(k)>-1){m=(l-f>=a.settings.pollingMs)}if(m){var p=a.getMousePos(n),o=TrackLib.XPath.getXPath(n.target),j=TrackLib.Util.serializeAttrs(n.target);a.fillInfo(n.id,l,p.x,p.y,k,o,j);f=l}},touchHandler:function(l){l=TrackLib.Events.fix(l);var k=l.changedTouches;if(k){for(var j=0,m;j<k.length;++j){m=k[j];m.type=l.type;a.eventHandler(m)}}},getMousePos:function(k){k=TrackLib.Events.fix(k);var j=0,l=0;if(k.pageX||k.pageY){j=k.pageX;l=k.pageY}else{if(k.clientX||k.clientY){j=k.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;l=k.clientY+document.body.scrollTop+document.documentElement.scrollTop}}if(!j||j<0){j=0}if(!l||l<0){l=0}return{x:j,y:l}},fillInfo:function(){var j=[].slice.apply(arguments);e.push(j.join(" "));a.log(j)},flush:function(j){a.log("Flushing data...",c);for(i=0;i<h.length;++i){TrackLib.Events.add(document,h[i],a.docHandler)}for(i=0;i<d.length;++i){TrackLib.Events.add(g,d[i],a.winHandler)}if(c){a.appendData(false)}else{a.initNewData(false)}},log:function(){if(a.settings.debug&&typeof console.log==="function"){console.log.apply(console,arguments)}}};g.TrackUI=a})(this);