/*! evtrack -- UI module */
var TrackUI={settings:{postServer:"http://my.server.org/save.script",postInterval:30,pollingEvents:[],pollingMs:150,taskName:"evtrack",layoutType:"liquid",debug:false},uid:0,time:new Date().getTime(),info:[],record:function(b){for(var f in TrackUI.settings){if(b.hasOwnProperty(f)&&b[f]!==null){TrackUI.settings[f]=b[f]}}TrackUI.log("Recording starts...",TrackUI.settings);var e="mousedown mouseup mousemove mouseover mouseout mousewheel click scroll "+"touchstart touchend touchmove keydown keyup keypress".split(" ");var d="blur focus resize".split(" ");var c;for(c=0;c<e.length;++c){TrackLib.Events.add(document,e[c],TrackUI.keyHandler)}for(c=0;c<d.length;++c){TrackLib.Events.add(window,d[c],TrackUI.winHandler)}if(document.attachEvent){TrackLib.Events.add(document.body,"focusout",TrackUI.winHandler);TrackLib.Events.add(document.body,"focusin",TrackUI.winHandler)}setTimeout(function(){TrackUI.initNewData(true)},TrackUI.settings.postInterval*1000);var a=(typeof window.onbeforeunload==="function")?"beforeunload":"unload";TrackLib.Events.add(window,a,TrackUI.flush)},initNewData:function(a){var d=TrackLib.Dimension.getWindowSize(),c=TrackLib.Dimension.getDocumentSize(),b="url="+escape(window.location.href);b+="&screenw="+screen.width;b+="&screenh="+screen.height;b+="&winw="+d.width;b+="&winh="+d.height;b+="&docw="+c.width;b+="&doch="+c.height;b+="&info="+TrackUI.info;b+="&task="+TrackUI.settings.taskName;b+="&layout="+TrackUI.settings.layoutType;b+="&cookies="+document.cookie;b+="&action=init";TrackUI.send({async:a,postdata:b,callback:TrackUI.setUserId});TrackUI.info=[]},setUserId:function(a){TrackUI.uid=parseInt(a);TrackUI.log("setUserId:",TrackUI.uid);if(TrackUI.uid){setInterval(function(){TrackUI.appendData(true)},TrackUI.settings.postInterval*1000)}},appendData:function(a){var b="uid="+TrackUI.uid;b+="&info="+TrackUI.info;b+="&action=append";TrackUI.send({async:a,postdata:b});TrackUI.info=[]},send:function(a){a.url=TrackUI.settings.postServer;TrackLib.XHR.sendAjaxRequest(a)},mouseHandler:function(a){TrackUI.eventHandler(a)},keyHandler:function(a){TrackUI.eventHandler(a)},winHandler:function(a){TrackUI.eventHandler(a)},eventHandler:function(f){f=TrackLib.Events.fix(f);var c=new Date().getTime(),b=f.type,d=true;if(TrackUI.settings.pollingMs>0&&TrackUI.settings.pollingEvents.indexOf(b)>-1){d=(c-TrackUI.time>=TrackUI.settings.pollingMs)}if(d){var h=TrackUI.getMousePos(f),g=TrackLib.XPath.getXPath(f.target),a=TrackLib.Util.serializeAttrs(f.target);TrackUI.fillInfo(f.id,c,h.x,h.y,b,g,a);TrackUI.time=c}},touchHandler:function(c){c=TrackLib.Events.fix(c);var b=c.changedTouches;if(b){for(var a=0,d;a<b.length;++a){d=b[a];d.type=c.type;TrackUI.eventHandler(d)}}},getMousePos:function(b){b=TrackLib.Events.fix(b);var a=0,c=0;if(b.pageX||b.pageY){a=b.pageX;c=b.pageY}else{if(b.clientX||b.clientY){a=b.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;c=b.clientY+document.body.scrollTop+document.documentElement.scrollTop}}if(!a||a<0){a=0}if(!c||c<0){c=0}return{x:a,y:c}},fillInfo:function(){var a=[].slice.apply(arguments);TrackUI.info.push(a.join(" "));TrackUI.log(a)},flush:function(a){TrackUI.log("Flushing data...",TrackUI.uid);if(TrackUI.uid){TrackUI.appendData(false)}else{TrackUI.initNewData(false)}},log:function(){if(TrackUI.settings.debug&&typeof console.log==="function"){console.log.apply(console,arguments)}}};