/*! evtrack -- UI module */
(function(d){var e=d.document;var b="mousedown mouseup mousemove mouseover mouseout mousewheel ";b+="touchstart touchend touchmove keydown keyup keypress ";b+="click dblclick scroll change select submit reset contextmenu cut copy paste";var c="load unload beforeunload blur focus resize error online offline";b=b.split(" ");c=c.split(" ");var a=b.concat(c);var f=0,i=0,h=[];var g={settings:{postServer:"http://my.server.org/save.script",postInterval:30,regularEvents:"*",pollingEvents:"",pollingMs:150,taskName:"evtrack",layoutType:"liquid",debug:false},record:function(j){i=new Date().getTime();for(var k in g.settings){if(j.hasOwnProperty(k)&&j[k]!==null){g.settings[k]=j[k]}}g.log("Recording starts...",i,g.settings);g.addEventListeners();setTimeout(function(){g.initNewData(true)},g.settings.postInterval*1000)},addEventListeners:function(){if(g.settings.regularEvents=="*"){g.addCustomEventListeners(a)}else{g.log("Settings regular events...");g.settings.regularEvents=g.settings.regularEvents.split(" ");g.addCustomEventListeners(g.settings.regularEvents)}if(g.settings.pollingEvents=="*"){g.addCustomEventListeners(a)}else{g.log("Settings polling events...");g.settings.pollingEvents=g.settings.pollingEvents.split(" ");g.addCustomEventListeners(g.settings.pollingEvents)}var j=(typeof d.onbeforeunload==="function")?"beforeunload":"unload";TrackLib.Events.add(d,j,g.flush)},addCustomEventListeners:function(l){g.log("Adding event listeners:",l);for(var j=0;j<l.length;++j){var k=l[j];if(!k){continue}if(b.indexOf(k)>-1){TrackLib.Events.add(e,k,g.docHandler);g.log("Adding document event:",k);if(e.attachEvent){if(k=="focus"){TrackLib.Events.add(e.body,"focusin",g.winHandler)}if(k=="blur"){TrackLib.Events.add(e.body,"focusout",g.winHandler)}}}else{if(c.indexOf(k)>-1){TrackLib.Events.add(d,k,g.winHandler);g.log("Adding window event:",k)}}}},initNewData:function(j){var m=TrackLib.Dimension.getWindowSize(),l=TrackLib.Dimension.getDocumentSize(),k="url="+encodeURIComponent(d.location.href);k+="&screenw="+screen.width;k+="&screenh="+screen.height;k+="&winw="+m.width;k+="&winh="+m.height;k+="&docw="+l.width;k+="&doch="+l.height;k+="&info="+encodeURIComponent(h.join("|||"));k+="&task="+encodeURIComponent(g.settings.taskName);k+="&action=init";g.send({async:j,postdata:k,callback:g.setUserId});h=[]},setUserId:function(j){f=parseInt(j.responseText);g.log("setUserId:",f);if(f){setInterval(function(){g.appendData(true)},g.settings.postInterval*1000)}},appendData:function(j){var k="uid="+f;k+="&info="+encodeURIComponent(h.join("|||"));k+="&action=append";g.send({async:j,postdata:k});h=[]},send:function(j){j.url=g.settings.postServer;TrackLib.XHR.sendAjaxRequest(j)},docHandler:function(j){if(j.type.indexOf("touch")>-1){g.touchHandler(j)}else{g.eventHandler(j)}},winHandler:function(j){g.eventHandler(j)},eventHandler:function(n){n=TrackLib.Events.fix(n);var l=new Date().getTime(),k=n.type,m=true;if(g.settings.pollingMs>0&&g.settings.pollingEvents.indexOf(k)>-1){m=(l-i>=g.settings.pollingMs)}if(m){var p=g.getMousePos(n),o=TrackLib.XPath.getXPath(n.target),j=TrackLib.Util.serializeAttrs(n.target);g.fillInfo(n.id,l,p.x,p.y,k,o,j);i=l}},touchHandler:function(l){l=TrackLib.Events.fix(l);var k=l.changedTouches;if(k){for(var j=0,m;j<k.length;++j){m=k[j];m.type=l.type;g.eventHandler(m)}}},getMousePos:function(k){k=TrackLib.Events.fix(k);var j=0,l=0;if(k.pageX||k.pageY){j=k.pageX;l=k.pageY}else{if(k.clientX||k.clientY){j=k.clientX+e.body.scrollLeft+e.documentElement.scrollLeft;l=k.clientY+e.body.scrollTop+e.documentElement.scrollTop}}if(!j||j<0){j=0}if(!l||l<0){l=0}return{x:j,y:l}},fillInfo:function(){var j=[].slice.apply(arguments);h.push(j.join(" "));g.log(j)},flush:function(k){g.log("Flushing data...",f);var j;for(j=0;j<b.length;++j){TrackLib.Events.remove(e,b[j],g.docHandler)}for(j=0;j<c.length;++j){TrackLib.Events.remove(d,c[j],g.winHandler)}if(f){g.appendData(false)}else{g.initNewData(false)}},log:function(){if(g.settings.debug&&typeof console.log==="function"){console.log.apply(console,arguments)}}};d.TrackUI=g})(this);