/* evtrack -- UI module */
var TrackUI={settings:{postServer:"http://my.server.org/save.script",postInterval:30,pollingMs:150,taskName:"evtrack",layoutType:"liquid",debug:false,},uid:0,time:new Date().getTime(),info:[],record:function(e){for(var h in TrackUI.settings){if(e.hasOwnProperty(h)&&e[h]!==null){TrackUI.settings[h]=e[h]}}TrackUI.log("Recording starts...",TrackUI.settings);var c=["mousedown","mouseup","mousemove","mouseover","mouseout","mousewheel","click","scroll"],g=["touchstart","touchend","touchmove"],d=["keydown","keyup","keypress"],a=["blur","focus","resize"],f;for(f=0;f<c.length;++f){TrackLib.Events.add(document,c[f],TrackUI.mouseHandler)}for(f=0;f<g.length;++f){TrackLib.Events.add(document,g[f],TrackUI.touchHandler)}for(f=0;f<d.length;++f){TrackLib.Events.add(document,d[f],TrackUI.keyHandler)}for(f=0;f<a.length;++f){TrackLib.Events.add(window,a[f],TrackUI.winHandler)}if(document.attachEvent){TrackLib.Events.add(document.body,"focusout",TrackUI.winHandler);TrackLib.Events.add(document.body,"focusin",TrackUI.winHandler)}setTimeout(function(){TrackUI.initNewData(true)},TrackUI.settings.postInterval*1000);var b=(typeof window.onbeforeunload==="function")?"beforeunload":"unload";TrackLib.Events.add(window,b,TrackUI.flush)},initNewData:function(a){var d=TrackLib.Dimension.getWindowSize(),c=TrackLib.Dimension.getDocumentSize(),b="url="+escape(window.location.href);b+="&screenw="+screen.width;b+="&screenh="+screen.height;b+="&winw="+d.width;b+="&winh="+d.height;b+="&docw="+c.width;b+="&doch="+c.height;b+="&info="+TrackUI.info;b+="&task="+TrackUI.settings.taskName;b+="&layout="+TrackUI.settings.layoutType;b+="&cookies="+document.cookie;b+="&action=init";TrackUI.send({async:a,postdata:b,callback:TrackUI.setUserId});TrackUI.info=[]},setUserId:function(a){TrackUI.uid=parseInt(a);TrackUI.log("setUserId:",TrackUI.uid);if(TrackUI.uid){setInterval(function(){TrackUI.appendData(true)},TrackUI.settings.postInterval*1000)}},appendData:function(a){var b="uid="+TrackUI.uid;b+="&info="+TrackUI.info;b+="&action=append";TrackUI.send({async:a,postdata:b});TrackUI.info=[]},send:function(a){a.url=TrackUI.settings.postServer;TrackLib.XHR.sendAjaxRequest(a)},mouseHandler:function(a){TrackUI.eventHandler(a)},keyHandler:function(a){TrackUI.eventHandler(a)},winHandler:function(a){TrackUI.eventHandler(a)},eventHandler:function(d){d=TrackLib.Events.fix(d);var b=new Date().getTime(),c=true;if(TrackUI.settings.pollingMs>0){c=(b-TrackUI.time>=TrackUI.settings.pollingMs)}if(c){var g=TrackUI.getMousePos(d),f=TrackLib.XPath.getXPath(d.target),a=TrackLib.Util.serializeAttrs(d.target);TrackUI.fillInfo(d.id,b,g.x,g.y,d.type,f,a);TrackUI.time=b}},touchHandler:function(c){c=TrackLib.Events.fix(c);var b=c.changedTouches;if(b){for(var a=0,d;a<b.length;++a){d=b[a];d.type=c.type;TrackUI.eventHandler(d)}}},getMousePos:function(b){b=TrackLib.Events.fix(b);var a=0,c=0;if(b.pageX||b.pageY){a=b.pageX;c=b.pageY}else{if(b.clientX||b.clientY){a=b.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;c=b.clientY+document.body.scrollTop+document.documentElement.scrollTop}}if(!a||a<0){a=0}if(!c||c<0){c=0}return{x:a,y:c}},fillInfo:function(){var a=[].slice.apply(arguments);TrackUI.info.push(a.join(" "));TrackUI.log(a)},flush:function(a){TrackUI.log("Flushing data...",TrackUI.uid);if(TrackUI.uid){TrackUI.appendData(false)}else{TrackUI.initNewData(false)}},log:function(){if(TrackUI.settings.debug&&typeof console.log==="function"){console.log.apply(console,arguments)}}};