/*! evtrack -- UI module */
(function(d){var e=d.document;var b="mousedown mouseup mousemove mouseover mouseout mousewheel ";b+="touchstart touchend touchmove keydown keyup keypress ";b+="click dblclick scroll change select submit reset contextmenu cut copy paste";var c="load unload beforeunload blur focus resize error online offline";b=b.split(" ");c=c.split(" ");var a=b.concat(c);var f=0,j=0,h=[];var g={settings:{postServer:"http://my.server.org/save.script",postInterval:30,regularEvents:"*",pollingEvents:"",pollingMs:150,taskName:"evtrack",layoutType:"liquid",debug:false},record:function(k){j=new Date().getTime();for(var l in g.settings){if(k.hasOwnProperty(l)&&k[l]!==null){g.settings[l]=k[l]}}g.log("Recording starts...",j,g.settings);g.addEventListeners();setTimeout(function(){g.initNewData(true)},g.settings.postInterval*1000)},addEventListeners:function(){if(g.settings.regularEvents=="*"){g.addCustomEventListeners(a)}else{g.log("Settings regular events...");g.settings.regularEvents=g.settings.regularEvents.split(" ");g.addCustomEventListeners(g.settings.regularEvents)}if(g.settings.pollingEvents=="*"){g.addCustomEventListeners(a)}else{g.log("Settings polling events...");g.settings.pollingEvents=g.settings.pollingEvents.split(" ");g.addCustomEventListeners(g.settings.pollingEvents)}var k=(typeof d.onbeforeunload==="function")?"beforeunload":"unload";TrackLib.Events.add(d,k,g.flush)},addCustomEventListeners:function(m){g.log("Adding event listeners:",m);for(var k=0;k<m.length;++k){var l=m[k];if(!l){continue}if(b.indexOf(l)>-1){TrackLib.Events.add(e,l,g.docHandler);g.log("Adding document event:",l);if(e.attachEvent){if(l=="focus"){TrackLib.Events.add(e.body,"focusin",g.winHandler)}if(l=="blur"){TrackLib.Events.add(e.body,"focusout",g.winHandler)}}}else{if(c.indexOf(l)>-1){TrackLib.Events.add(d,l,g.winHandler);g.log("Adding window event:",l)}}}},initNewData:function(k){var n=TrackLib.Dimension.getWindowSize(),m=TrackLib.Dimension.getDocumentSize(),l="url="+escape(d.location.href);l+="&screenw="+screen.width;l+="&screenh="+screen.height;l+="&winw="+n.width;l+="&winh="+n.height;l+="&docw="+m.width;l+="&doch="+m.height;l+="&info="+h;l+="&task="+g.settings.taskName;l+="&layout="+g.settings.layoutType;l+="&cookies="+e.cookie;l+="&action=init";g.send({async:k,postdata:l,callback:g.setUserId});h=[]},setUserId:function(k){f=parseInt(k);g.log("setUserId:",f);if(f){setInterval(function(){g.appendData(true)},g.settings.postInterval*1000)}},appendData:function(k){var l="uid="+f;l+="&info="+h;l+="&action=append";g.send({async:k,postdata:l});h=[]},send:function(k){k.url=g.settings.postServer;TrackLib.XHR.sendAjaxRequest(k)},docHandler:function(k){if(k.type.indexOf("touch")>-1){g.touchHandler(k)}else{g.eventHandler(k)}},winHandler:function(k){g.eventHandler(k)},eventHandler:function(o){o=TrackLib.Events.fix(o);var m=new Date().getTime(),l=o.type,n=true;if(g.settings.pollingMs>0&&g.settings.pollingEvents.indexOf(l)>-1){n=(m-j>=g.settings.pollingMs)}if(n){var q=g.getMousePos(o),p=TrackLib.XPath.getXPath(o.target),k=TrackLib.Util.serializeAttrs(o.target);g.fillInfo(o.id,m,q.x,q.y,l,p,k);j=m}},touchHandler:function(m){m=TrackLib.Events.fix(m);var l=m.changedTouches;if(l){for(var k=0,n;k<l.length;++k){n=l[k];n.type=m.type;g.eventHandler(n)}}},getMousePos:function(l){l=TrackLib.Events.fix(l);var k=0,m=0;if(l.pageX||l.pageY){k=l.pageX;m=l.pageY}else{if(l.clientX||l.clientY){k=l.clientX+e.body.scrollLeft+e.documentElement.scrollLeft;m=l.clientY+e.body.scrollTop+e.documentElement.scrollTop}}if(!k||k<0){k=0}if(!m||m<0){m=0}return{x:k,y:m}},fillInfo:function(){var k=[].slice.apply(arguments);h.push(k.join(" "));g.log(k)},flush:function(k){g.log("Flushing data...",f);for(i=0;i<b.length;++i){TrackLib.Events.add(e,b[i],g.docHandler)}for(i=0;i<c.length;++i){TrackLib.Events.add(d,c[i],g.winHandler)}if(f){g.appendData(false)}else{g.initNewData(false)}},log:function(){if(g.settings.debug&&typeof console.log==="function"){console.log.apply(console,arguments)}}};d.TrackUI=g})(this);